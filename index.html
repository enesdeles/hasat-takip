<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hasat Takip</title>
<link rel="manifest" href="/hasat-takip/manifest.json">
<meta name="theme-color" content="#2e7d32">
<style>
body{font-family:Arial;background:#f4f6f8;margin:0;padding:10px}
h1{text-align:center;color:#2e7d32}
button{width:100%;padding:12px;margin-top:8px;font-size:16px;background:#2e7d32;color:#fff;border:none;border-radius:6px;cursor:pointer}
button:active{opacity:0.8}
button.gray{background:#607d8b}
button.blue{background:#1976d2}
button.red{background:#c62828}
.section{background:#fff;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #ddd}
.hidden{display:none}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:8px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#e8f5e9;color:#2e7d32}
select,input{width:95%;padding:6px;border:1px solid #ddd;border-radius:4px}
.personel-item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #eee}
#total{text-align:center;font-size:18px;font-weight:bold;margin-top:10px;padding:10px;background:#fff;border-radius:6px}
</style>
</head>

<body>

<h1>ğŸŒ± Hasat Takip</h1>

<button class="gray" onclick="togglePersonel()">ğŸ‘¥ Personel YÃ¶netimi</button>
<div id="personelPanel" class="section hidden">
  <input id="newPersonel" placeholder="Ä°sim Soyisim gir">
  <button onclick="addPersonel()">â• Personel Ekle</button>
  <div id="personelList"></div>
</div>

<button onclick="location.href='olu-bitki.html'">ğŸŒ¿ Ã–lÃ¼ Bitki Takibe GeÃ§</button>

<table id="table">
<tr><th>TÃ¼nel</th><th>SÄ±ra</th><th>Personel</th><th>Kutu</th></tr>
</table>

<div id="total">Toplam Kutu: 0</div>

<div class="section">
    <button class="blue" onclick="finishDay()">ğŸ’¾ GÃ¼nÃ¼ Bitir ve Veriyi ArÅŸivle</button>
    <button class="gray" onclick="downloadReport()">ğŸ“Š TÃ¼m GeÃ§miÅŸ Raporu Ä°ndir (Excel)</button>
</div>

<button class="red" onclick="clearPage()">ğŸ—‘ï¸ Sadece SayfayÄ± Temizle (Kaydetmeden)</button>

<script>
// --- AYARLAR ---
const PERSONEL_KEY="sera_personeller"
const DATA_KEY="hasat_kayitlar"
const HISTORY_KEY="genel_is_gecmisi" // RaporlarÄ±n birikeceÄŸi ortak havuz

const defaultPersoneller=[
"Akile","Beyhan","Emine tÃ¼rk","Emine yavuz","EmiÅŸ","EsengÃ¼l","Fadime",
"Fatma Demiral","Fatma karabulut","GÃ¼lbeyaz gÃ¼ler","GÃ¼lbeyaz Ã–ztop",
"Keziban tasoluk","Keziban yÃ¼ce","Keziban yÃ¼ksek","Meryem","MÃ¼jgan",
"MÃ¼mine","Neslihan","Ã–zgÃ¼l","Raziye koÃ§ak","Raziye sarÄ±",
"Safiye aslan","Safiye coÅŸkun","Safiye karaca","SatÄ± karakaya",
"SatÄ± taskin","Sultan","ÅengÃ¼l","Åerife avcÄ±","Åerife demiral",
"Ummuhan Ã¶zdemir","YaÅŸar"
]

// --- VERÄ° YÃ–NETÄ°MÄ° ---
let personeller=JSON.parse(localStorage.getItem(PERSONEL_KEY))||defaultPersoneller
localStorage.setItem(PERSONEL_KEY,JSON.stringify(personeller))

let data=JSON.parse(localStorage.getItem(DATA_KEY))||{}

function sorted(){return [...personeller].sort((a,b)=>a.localeCompare(b,'tr'))}

const table=document.getElementById("table")

// Tabloyu OluÅŸtur (19 TÃ¼nel, 6 SÄ±ra)
for(let t=19;t>=1;t--){
    for(let s=1;s<=6;s++){
        const id=`${t}-${s}`
        const tr=document.createElement("tr")
        tr.dataset.id=id
        tr.innerHTML=`
        <td><b>${t}</b></td>
        <td>${s}</td>
        <td>${personelSelect(id)}</td>
        <td>${kutuSelect(id)}</td>`
        table.appendChild(tr)
    }
}

function personelSelect(id){
    let h=`<select onchange="save('${id}','p',this.value)"><option value="">SeÃ§</option>`
    sorted().forEach(p=>h+=`<option>${p}</option>`)
    return h+="</select>"
}

function kutuSelect(id){
    let h=`<select onchange="save('${id}','k',this.value)">`
    for(let i=0;i<=200;i++)h+=`<option>${i}</option>`
    return h+="</select>"
}

function save(id,t,v){
    data[id]=data[id]||{}
    data[id][t]=v
    
    // BoÅŸ veri temizliÄŸi
    if(v==="" || v==="0") {
        if(t==='p' && v==="") delete data[id].p
        if(t==='k' && v==="0") delete data[id].k
        if(Object.keys(data[id]).length===0) delete data[id]
    }

    localStorage.setItem(DATA_KEY,JSON.stringify(data))
    calc()
}

function restore(){
    Object.keys(data).forEach(id=>{
        const r=document.querySelector(`tr[data-id="${id}"]`)
        if(!r)return
        const s=r.querySelectorAll("select")
        if(data[id].p)s[0].value=data[id].p
        if(data[id].k)s[1].value=data[id].k
    })
    calc()
}

function calc(){
    let sum=0
    Object.values(data).forEach(r=>sum+=Number(r.k||0))
    document.getElementById("total").innerText="Toplam Kutu: "+sum
}

// --- PERSONEL YÃ–NETÄ°MÄ° ---
function togglePersonel(){
    document.getElementById("personelPanel").classList.toggle("hidden")
    renderPersonel()
}

function renderPersonel(){
    const d=document.getElementById("personelList")
    d.innerHTML=""
    sorted().forEach((p,i)=>{
        d.innerHTML+=`<div class="personel-item">${p}<button onclick="removePersonel(${i})" style="width:auto;padding:5px;margin:0;background:#c62828">Sil</button></div>`
    })
}

function addPersonel(){
    const i=document.getElementById("newPersonel")
    if(!i.value.trim())return
    personeller.push(i.value.trim())
    localStorage.setItem(PERSONEL_KEY,JSON.stringify(personeller))
    i.value=""
    alert("Personel eklendi! Listeler gÃ¼ncelleniyor...")
    location.reload() // Listelerin gÃ¼ncellenmesi iÃ§in yenile
}

function removePersonel(i){
    if(!confirm("Bu personeli silmek istediÄŸine emin misin?")) return
    const silinecek = sorted()[i]
    personeller = personeller.filter(p => p !== silinecek)
    localStorage.setItem(PERSONEL_KEY,JSON.stringify(personeller))
    renderPersonel()
    alert("Personel silindi! Sayfa yenileniyor...")
    location.reload()
}

// --- RAPORLAMA VE ARÅÄ°V SÄ°STEMÄ° ---

function finishDay() {
    if(Object.keys(data).length === 0) {
        alert("Kaydedilecek veri yok!");
        return;
    }
    
    if(!confirm("GÃ¼nÃ¼ bitirmek Ã¼zeresiniz.\n\nBu iÅŸlem tablodaki verileri 'GeÃ§miÅŸ Raporlar'a kaydedecek ve ekranÄ± temizleyecektir.\n\nOnaylÄ±yor musunuz?")) return;

    // GeÃ§miÅŸ veriyi Ã§ek
    let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
    const bugun = new Date().toLocaleDateString('tr-TR');
    const saat = new Date().toLocaleTimeString('tr-TR');

    // Mevcut tabloyu geÃ§miÅŸe iÅŸle
    Object.keys(data).forEach(id => {
        const item = data[id];
        if(item.p && item.k && item.k != "0") { // Sadece personel ve sayÄ± varsa kaydet
            const [tunel, sira] = id.split("-");
            history.push({
                tarih: bugun,
                saat: saat,
                tur: "Hasat", // Ä°Å TÃœRÃœ
                personel: item.p,
                tunel: tunel,
                sira: sira,
                adet: item.k
            });
        }
    });

    // GeÃ§miÅŸi kaydet
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));

    // EkranÄ± temizle
    data = {};
    localStorage.removeItem(DATA_KEY);
    document.querySelectorAll("select").forEach(s => {
        if(s.options[0].text === "SeÃ§") s.value = "";
        else s.value = "0"; 
    });
    calc();

    alert("âœ… Veriler baÅŸarÄ±yla arÅŸivlendi ve yeni gÃ¼n iÃ§in sayfa temizlendi.");
}

function downloadReport() {
    let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
    if(history.length === 0) {
        alert("HenÃ¼z kaydedilmiÅŸ bir geÃ§miÅŸ rapor yok.");
        return;
    }

    // CSV BaÅŸlÄ±ÄŸÄ± (Excel iÃ§in BOM eklendi)
    let csvContent = "\uFEFFTarih;Saat;Ä°ÅŸ TÃ¼rÃ¼;Personel;TÃ¼nel;SÄ±ra;Miktar\n";

    history.forEach(row => {
        csvContent += `${row.tarih};${row.saat};${row.tur};${row.personel};${row.tunel};${row.sira};${row.adet}\n`;
    });

    // Ä°ndirme iÅŸlemi
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", "hasat_raporu_" + new Date().toLocaleDateString('tr-TR') + ".csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function clearPage(){
    if(!confirm("DÄ°KKAT: Veriler ARÅÄ°VLENMEDEN silinecek. Emin misiniz?"))return
    data={}
    localStorage.removeItem(DATA_KEY)
    document.querySelectorAll("select").forEach(s => {
        if(s.options[0].text === "SeÃ§") s.value = "";
        else s.value = "0"; 
    });
    calc()
}

restore()
</script>

</body>
</html>
