<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Hasat Takip</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;padding:10px}
h1{text-align:center;color:#2e7d32}
button{width:100%;padding:12px;margin-top:8px;font-size:16px;background:#2e7d32;color:#fff;border:none;border-radius:6px;cursor:pointer}
button.blue{background:#1976d2}
button.gray{background:#607d8b}
button.red{background:#c62828}
button.pdf{background:#f44336}
.section{background:#fff;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #ddd}
.hidden{display:none}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:8px}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#e8f5e9}
select{width:95%;padding:8px;font-size:14px}
#total{text-align:center;font-size:18px;font-weight:bold;margin:10px 0;padding:10px;background:#fff}
</style>
</head>
<body>

<h1>ğŸŒ± Hasat Takip</h1>

<button class="gray" onclick="togglePersonel()">ğŸ‘¥ Personel YÃ¶netimi</button>
<div id="personelPanel" class="section hidden">
    <input id="newPersonel" style="width:70%;padding:10px" placeholder="Ä°sim Soyisim">
    <button onclick="addPersonel()" style="width:25%">â• Ekle</button>
    <div id="personelList" style="margin-top:10px"></div>
</div>

<button class="blue" onclick="location.href='olu-bitki.html'">ğŸŒ¿ Ã–lÃ¼ Bitki Takibe GeÃ§</button>

<table id="table">
    <thead><tr><th>TÃ¼nel</th><th>SÄ±ra</th><th>Personel</th><th>Kutu</th></tr></thead>
    <tbody id="tableBody"></tbody>
</table>

<div id="total">Toplam Kutu: 0</div>

<div class="section">
    <button class="pdf" onclick="generatePDF()">ğŸ“„ Tabloyu PDF Yap (PaylaÅŸ)</button>
    <button class="blue" onclick="finishDay()">ğŸ’¾ GÃ¼nÃ¼ Bitir ve ArÅŸivle</button>
    <button class="gray" onclick="downloadReport()">ğŸ“Š Eski KayÄ±tlarÄ± Excel Ä°ndir</button>
</div>

<button class="red" onclick="clearPage()">ğŸ—‘ï¸ SayfayÄ± Temizle</button>

<script>
const PERSONEL_KEY="sera_personeller", DATA_KEY="hasat_kayitlar", HISTORY_KEY="genel_is_gecmisi";
const defaultP=["Akile","Beyhan","Emine tÃ¼rk","Emine yavuz","EmiÅŸ","EsengÃ¼l","Fadime","Fatma Demiral","Fatma karabulut","GÃ¼lbeyaz gÃ¼ler","GÃ¼lbeyaz Ã–ztop","Keziban tasoluk","Keziban yÃ¼ce","Keziban yÃ¼ksek","Meryem","MÃ¼jgan","MÃ¼mine","Neslihan","Ã–zgÃ¼l","Raziye koÃ§ak","Raziye sarÄ±","Safiye aslan","Safiye coÅŸkun","Safiye karaca","SatÄ± karakaya","SatÄ± taskin","Sultan","ÅengÃ¼l","Åerife avcÄ±","Åerife demiral","Ummuhan Ã¶zdemir","YaÅŸar"];

let personeller=JSON.parse(localStorage.getItem(PERSONEL_KEY))||defaultP;
let data=JSON.parse(localStorage.getItem(DATA_KEY))||{};

function sorted(){return [...personeller].sort((a,b)=>a.localeCompare(b,'tr'))}

function renderTable(){
    let h="";
    for(let t=19;t>=1;t--){
        for(let s=1;s<=6;s++){
            const id=`${t}-${s}`;
            h+=`<tr data-id="${id}"><td><b>${t}</b></td><td>${s}</td><td>${pSel(id)}</td><td>${kSel(id)}</td></tr>`;
        }
    }
    document.getElementById("tableBody").innerHTML=h;
    restore();
}

function pSel(id){
    let o=`<option value="">SeÃ§</option>`;
    sorted().forEach(p=>o+=`<option value="${p}">${p}</option>`);
    return `<select onchange="save('${id}','p',this.value)">${o}</select>`;
}

function kSel(id){
    let o="";
    for(let i=0;i<=200;i++)o+=`<option value="${i}">${i}</option>`;
    return `<select onchange="save('${id}','k',this.value)">${o}</select>`;
}

function save(id,t,v){
    data[id]=data[id]||{}; data[id][t]=v;
    localStorage.setItem(DATA_KEY,JSON.stringify(data));
    calc();
}

function calc(){
    let sum=0;
    Object.values(data).forEach(r=>sum+=Number(r.k||0));
    document.getElementById("total").innerText="Toplam Kutu: "+sum;
}

function restore(){
    Object.keys(data).forEach(id=>{
        const r=document.querySelector(`tr[data-id="${id}"]`);
        if(r){const s=r.querySelectorAll("select"); s[0].value=data[id].p||""; s[1].value=data[id].k||"0";}
    });
    calc();
}

// PDF OLUÅTURMA FONKSÄ°YONU
async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const tarih = new Date().toLocaleDateString('tr-TR');
    
    doc.text("Hasat Takip Raporu - " + tarih, 14, 15);
    
    let tableData = [];
    Object.keys(data).forEach(id => {
        if(data[id].p && data[id].k > 0) {
            const [tun, sir] = id.split("-");
            tableData.push([tun, sir, data[id].p, data[id].k]);
        }
    });

    if(tableData.length === 0) { alert("Tablo boÅŸ, rapor oluÅŸturulamaz!"); return; }

    doc.autoTable({
        head: [['TÃ¼nel', 'SÄ±ra', 'Personel', 'Kutu']],
        body: tableData,
        startY: 20
    });

    doc.save(`Hasat_Raporu_${tarih}.pdf`);
}

function finishDay(){
    if(!confirm("Veriler arÅŸive eklenecek ve ekran temizlenecek?")) return;
    let history=JSON.parse(localStorage.getItem(HISTORY_KEY))||[];
    const tarih=new Date().toLocaleDateString('tr-TR');
    Object.keys(data).forEach(id=>{
        if(data[id].p && data[id].k > 0){
            const [tun,sir]=id.split("-");
            history.push({tarih, tur:"Hasat", p:data[id].p, t:tun, s:sir, a:data[id].k});
        }
    });
    localStorage.setItem(HISTORY_KEY,JSON.stringify(history));
    data={}; localStorage.removeItem(DATA_KEY);
    location.reload();
}

function downloadReport(){
    let history=JSON.parse(localStorage.getItem(HISTORY_KEY))||[];
    if(!history.length){alert("Rapor yok!"); return;}
    
    // Excel'in TÃ¼rkÃ§e karakterleri ve tarihleri tanÄ±masÄ± iÃ§in UTF-8 BOM ekliyoruz
    let csv="\uFEFFTarih;Ä°ÅŸ TÃ¼rÃ¼;Personel;TÃ¼nel;SÄ±ra;Adet\n";
    
    history.forEach(r => {
        // Tarihin Excel'de metin olarak kalmasÄ± iÃ§in baÅŸÄ±na tek tÄ±rnak eklenebilir 
        // veya GG.AA.YYYY formatÄ± garanti edilir
        let formatiTarih = r.tarih; 
        csv += `${formatiTarih};${r.tur};${r.p};${r.t};${r.s};${r.a}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const a = document.createElement("a");
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = "Sera_Hasat_Raporu.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycby3vpGSGGHkU5_gYM3NpfUwk6J05qNWZpHsTA0-ZYWlOcdHFkX9nJU20VaLbRyMSd7Phw/exec";

async function sendToGoogleSheets() {
    let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
    if(history.length === 0) { alert("GÃ¶nderilecek veri yok!"); return; }

    const button = event.target;
    button.innerText = "GÃ¶nderiliyor...";
    button.disabled = true;

    try {
        const response = await fetch(GOOGLE_SHEET_URL, {
            method: "POST",
            mode: "no-cors", // GÃ¼venlik kÄ±sÄ±tlamasÄ±nÄ± aÅŸmak iÃ§in
            cache: "no-cache",
            body: JSON.stringify(history)
        });
        
        alert("âœ… Veriler Google E-Tablolara baÅŸarÄ±yla gÃ¶nderildi!");
        // GÃ¶nderilen verileri arÅŸivden silmek isterseniz:
        // localStorage.removeItem(HISTORY_KEY); 
    } catch (error) {
        console.error(error);
        alert("âŒ Bir hata oluÅŸtu.");
    } finally {
        button.innerText = "ğŸ“Š Google E-Tablolara GÃ¶nder";
        button.disabled = false;
    }
}

function togglePersonel(){document.getElementById("personelPanel").classList.toggle("hidden"); renderPersonel();}
function renderPersonel(){
    const d=document.getElementById("personelList"); d.innerHTML="";
    sorted().forEach((p)=>d.innerHTML+=`<div style="display:flex;justify-content:space-between;padding:5px;border-bottom:1px solid #eee">${p} <button onclick="removeP('${p}')" style="width:auto;background:red;padding:2px 8px;margin:0">X</button></div>`);
}
function addPersonel(){
    const val=document.getElementById("newPersonel").value;
    if(!val)return; personeller.push(val);
    localStorage.setItem(PERSONEL_KEY,JSON.stringify(personeller));
    location.reload();
}
function removeP(p){
    personeller=personeller.filter(x=>x!==p);
    localStorage.setItem(PERSONEL_KEY,JSON.stringify(personeller));
    location.reload();
}
function clearPage(){ if(confirm("Kaydetmeden temizle?")){ data={}; localStorage.removeItem(DATA_KEY); location.reload(); }}

renderTable();
</script>
</body>
</html>


