<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ã–lÃ¼ Bitki Takibi</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;padding:10px}
h1{text-align:center;color:#c62828}
button{width:100%;padding:12px;margin-top:8px;font-size:16px;background:#c62828;color:#fff;border:none;border-radius:6px;cursor:pointer}
button.blue{background:#1565c0}
button.gray{background:#607d8b}
button.pdf{background:#f44336}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#fdecea}
select{width:100%;padding:8px}
#total{text-align:center;font-size:18px;font-weight:bold;margin:15px 0;padding:10px;background:#fff}
</style>
</head>
<body>

<h1>ğŸŒ¿ Ã–lÃ¼ Bitki Kesimi</h1>
<button class="gray" onclick="window.location.href='index.html'">â¬…ï¸ Geri DÃ¶n</button>

<table id="table">
    <thead><tr><th>TÃ¼nel</th><th>SÄ±ra</th><th>Personel</th><th>Adet</th></tr></thead>
    <tbody id="tableBody"></tbody>
</table>

<div id="total">Toplam Kesilen: 0</div>

<div style="background:#fff; padding:10px; border-radius:6px; border:1px solid #ddd">
    <button class="pdf" onclick="generatePDF()">ğŸ“„ Tabloyu PDF Yap</button>
    <button class="blue" onclick="finishDay()">ğŸ’¾ GÃ¼nÃ¼ Bitir ve ArÅŸivle</button>
    <button class="gray" onclick="downloadReport()">ğŸ“Š Eski KayÄ±tlarÄ± Excel Ä°ndir</button>
</div>

<script>
const PERSONEL_KEY = "sera_personeller", DATA_KEY = "olu_bitki_data", HISTORY_KEY = "genel_is_gecmisi";
let personeller = JSON.parse(localStorage.getItem(PERSONEL_KEY)) || [];
let data = JSON.parse(localStorage.getItem(DATA_KEY)) || {};

function sorted() { return [...personeller].sort((a, b) => a.localeCompare(b, 'tr')); }

function renderTable() {
    let h = "";
    for(let t = 19; t >= 1; t--) {
        for(let s = 1; s <= 6; s++) {
            const id = `${t}-${s}`;
            h += `<tr data-id="${id}"><td><b>${t}</b></td><td>${s}</td><td>${pSel(id)}</td><td>${kSel(id)}</td></tr>`;
        }
    }
    document.getElementById("tableBody").innerHTML = h;
    restore();
}

function pSel(id) {
    let o = `<option value="">SeÃ§</option>`;
    sorted().forEach(p => o += `<option value="${p}">${p}</option>`);
    return `<select onchange="save('${id}','p',this.value)">${o}</select>`;
}

function kSel(id) {
    let o = "";
    for(let i = 0; i <= 500; i++) o += `<option value="${i}">${i}</option>`;
    return `<select onchange="save('${id}','k',this.value)">${o}</select>`;
}

function save(id, t, v) {
    data[id] = data[id] || {}; data[id][t] = v;
    localStorage.setItem(DATA_KEY, JSON.stringify(data));
    calc();
}

function calc() {
    let sum = 0;
    Object.values(data).forEach(i => sum += Number(i.k || 0));
    document.getElementById("total").innerText = "Toplam Kesilen: " + sum;
}

function restore() {
    Object.keys(data).forEach(id => {
        const row = document.querySelector(`tr[data-id="${id}"]`);
        if (row) {
            const s = row.querySelectorAll("select");
            s[0].value = data[id].p || "";
            s[1].value = data[id].k || "0";
        }
    });
    calc();
}

async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const tarih = new Date().toLocaleDateString('tr-TR');
    doc.text("Olu Bitki Kesim Raporu - " + tarih, 14, 15);
    let tableData = [];
    Object.keys(data).forEach(id => {
        if(data[id].p && data[id].k > 0) {
            const [tun, sir] = id.split("-");
            tableData.push([tun, sir, data[id].p, data[id].k]);
        }
    });
    if(tableData.length === 0) { alert("Tablo boÅŸ!"); return; }
    doc.autoTable({ head: [['TÃ¼nel', 'SÄ±ra', 'Personel', 'Adet']], body: tableData, startY: 20 });
    doc.save(`Olu_Bitki_Raporu_${tarih}.pdf`);
}

function finishDay(){
    if(!confirm("ArÅŸivlensin mi?")) return;
    let history=JSON.parse(localStorage.getItem(HISTORY_KEY))||[];
    const tarih=new Date().toLocaleDateString('tr-TR');
    Object.keys(data).forEach(id=>{
        if(data[id].p && data[id].k > 0){
            const [tun,sir]=id.split("-");
            history.push({tarih, tur:"Ã–lÃ¼ Bitki", p:data[id].p, t:tun, s:sir, a:data[id].k});
        }
    });
    localStorage.setItem(HISTORY_KEY,JSON.stringify(history));
    data={}; localStorage.removeItem(DATA_KEY);
    location.reload();
}

function downloadReport(){
    let history=JSON.parse(localStorage.getItem(HISTORY_KEY))||[];
    if(!history.length){alert("Rapor yok!"); return;}
    let csv="\uFEFFTarih;Ä°ÅŸ TÃ¼rÃ¼;Personel;TÃ¼nel;SÄ±ra;Adet\n";
    history.forEach(r=>csv+=`${r.tarih};${r.tur};${r.p};${r.t};${r.s};${r.a}\n`);
    const blob=new Blob([csv],{type:'text/csv'});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="genel_arsiv.csv"; a.click();
}

renderTable();
</script>
</body>
</html>
