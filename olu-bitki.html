<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>√ñl√º Bitki Kesimi</title>
<style>
body{font-family:Arial;background:#f4f6f8;margin:0;padding:10px}
h1{text-align:center;color:#c62828}
button{width:100%;padding:12px;margin-top:8px;font-size:16px;background:#c62828;color:#fff;border:none;border-radius:6px;cursor:pointer}
button.gray{background:#607d8b}
button.blue{background:#1565c0}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#fdecea;color:#c62828}
select{width:100%;padding:8px}
#total{text-align:center;font-size:18px;font-weight:bold;margin-top:15px;padding:10px;background:#fff}
</style>
</head>
<body>

<h1>üåø √ñl√º Bitki Kesimi</h1>
<button class="gray" onclick="window.location.href='index.html'">‚¨ÖÔ∏è Hasat Takibe D√∂n</button>

<table id="table">
<thead><tr><th>T√ºnel</th><th>Sƒ±ra</th><th>Personel</th><th>Adet</th></tr></thead>
<tbody id="tableBody"></tbody>
</table>

<div id="total">Toplam Kesilen Bitki: 0</div>

<div style="background:#fff; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #ddd">
    <button class="blue" onclick="finishDay()">üíæ G√ºn√º Bitir ve Ar≈üivle</button>
    <button class="gray" onclick="downloadReport()">üìä Raporu ƒ∞ndir (Excel)</button>
</div>

<script>
const PERSONEL_KEY = "sera_personeller"; 
const DATA_KEY = "olu_bitki_data";
const HISTORY_KEY = "genel_is_gecmisi";

const defaultP = ["Akile","Beyhan","Emine t√ºrk","Emine yavuz","Emi≈ü","Eseng√ºl","Fadime","Fatma Demiral","Fatma karabulut","G√ºlbeyaz g√ºler","G√ºlbeyaz √ñztop","Keziban tasoluk","Keziban y√ºce","Keziban y√ºksek","Meryem","M√ºjgan","M√ºmine","Neslihan","√ñzg√ºl","Raziye ko√ßak","Raziye sarƒ±","Safiye aslan","Safiye co≈ükun","Safiye karaca","Satƒ± karakaya","Satƒ± taskin","Sultan","≈ûeng√ºl","≈ûerife avcƒ±","≈ûerife demiral","Ummuhan √∂zdemir","Ya≈üar"];

let personeller = JSON.parse(localStorage.getItem(PERSONEL_KEY)) || defaultP;
let data = JSON.parse(localStorage.getItem(DATA_KEY)) || {};

function sorted() { return [...personeller].sort((a, b) => a.localeCompare(b, 'tr')); }

function renderTable() {
    let h = "";
    for(let t = 19; t >= 1; t--) {
        for(let s = 1; s <= 6; s++) {
            const id = `${t}-${s}`;
            h += `<tr data-id="${id}"><td><b>${t}</b></td><td>${s}</td><td>${pSel(id)}</td><td>${kSel(id)}</td></tr>`;
        }
    }
    document.getElementById("tableBody").innerHTML = h;
    restore();
}

function pSel(id) {
    let o = `<option value="">Se√ßiniz</option>`;
    sorted().forEach(p => o += `<option value="${p}">${p}</option>`);
    return `<select onchange="save('${id}','p',this.value)">${o}</select>`;
}

function kSel(id) {
    let o = "";
    for(let i = 0; i <= 500; i++) o += `<option value="${i}">${i}</option>`;
    return `<select onchange="save('${id}','k',this.value)">${o}</select>`;
}

function save(id, t, v) {
    data[id] = data[id] || {};
    data[id][t] = v;
    localStorage.setItem(DATA_KEY, JSON.stringify(data));
    calc();
}

function calc() {
    let sum = 0;
    Object.values(data).forEach(i => sum += Number(i.k || 0));
    document.getElementById("total").innerText = "Toplam Kesilen Bitki: " + sum;
}

function finishDay(){
    if(!confirm("Veriler √ñl√º Bitki olarak ar≈üive eklenecek. Emin misiniz?")) return;
    let history=JSON.parse(localStorage.getItem(HISTORY_KEY))||[];
    const tarih=new Date().toLocaleDateString('tr-TR');
    Object.keys(data).forEach(id=>{
        if(data[id].p && data[id].k > 0){
            const [tun,sir]=id.split("-");
            history.push({tarih, tur:"√ñl√º Bitki", p:data[id].p, t:tun, s:sir, a:data[id].k});
        }
    });
    localStorage.setItem(HISTORY_KEY,JSON.stringify(history));
    data={}; localStorage.removeItem(DATA_KEY);
    alert("Ar≈üivlendi!"); location.reload();
}

function downloadReport(){
    let history=JSON.parse(localStorage.getItem(HISTORY_KEY))||[];
    if(!history.length){alert("Rapor yok!"); return;}
    let csv="\uFEFFTarih;ƒ∞≈ü T√ºr√º;Personel;T√ºnel;Sƒ±ra;Adet\n";
    history.forEach(r=>csv+=`${r.tarih};${r.tur};${r.p};${r.t};${r.s};${r.a}\n`);
    const blob=new Blob([csv],{type:'text/csv'});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="rapor.csv"; a.click();
}

function restore() {
    Object.keys(data).forEach(id => {
        const row = document.querySelector(`tr[data-id="${id}"]`);
        if (row) {
            const s = row.querySelectorAll("select");
            s[0].value = data[id].p || "";
            s[1].value = data[id].k || "0";
        }
    });
    calc();
}

renderTable();
</script>
</body>
</html>
