<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ã–lÃ¼ Bitki Kesimi</title>
<link rel="manifest" href="/hasat-takip/manifest.json">
<meta name="theme-color" content="#c62828">
<style>
/* TasarÄ±m ayarlarÄ± */
body{font-family:Arial;background:#f4f6f8;margin:0;padding:10px}
h1{text-align:center;color:#c62828}
button{width:100%;padding:12px;margin-top:8px;font-size:16px;background:#c62828;color:#fff;border:none;border-radius:6px;cursor:pointer}
button:active{opacity:0.8}
button.gray{background:#607d8b}
button.blue{background:#1565c0}
button.red{background:#8e0000}
.section{background:#fff;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #ddd}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#fdecea;color:#c62828}
select{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;background:#fff}
#total{text-align:center;font-size:18px;font-weight:bold;margin-top:15px;padding:10px;background:#fff;border-radius:6px}
</style>
</head>

<body>

<h1>ğŸŒ¿ Ã–lÃ¼ Bitki Kesimi</h1>
<button class="gray" onclick="window.location.href='index.html'">â¬…ï¸ Hasat Takibe DÃ¶n</button>

<table id="table">
<thead>
    <tr>
        <th style="width:15%">TÃ¼nel</th>
        <th style="width:15%">SÄ±ra</th>
        <th>Personel</th>
        <th style="width:20%">Adet</th>
    </tr>
</thead>
<tbody id="tableBody">
    </tbody>
</table>

<div id="total">Toplam Kesilen Bitki: 0</div>

<div class="section">
    <button class="blue" onclick="finishDay()">ğŸ’¾ GÃ¼nÃ¼ Bitir ve Veriyi ArÅŸivle</button>
    <button class="gray" onclick="downloadReport()">ğŸ“Š TÃ¼m GeÃ§miÅŸ Raporu Ä°ndir (Excel)</button>
</div>

<button class="red" onclick="clearPage()">ğŸ—‘ï¸ Sadece SayfayÄ± Temizle (Kaydetmeden)</button>

<script>
// --- AYARLAR VE VERÄ° YÃ–NETÄ°MÄ° ---

// index.html ile aynÄ± anahtarÄ± kullanÄ±yoruz
const PERSONEL_KEY = "sera_personeller"; 
const DATA_KEY = "olu_bitki_data";
const HISTORY_KEY = "genel_is_gecmisi"; // Ortak rapor havuzu

// EÄŸer hafÄ±zada liste yoksa kullanÄ±lacak yedek liste
const defaultPersoneller = [
"Akile","Beyhan","Emine tÃ¼rk","Emine yavuz","EmiÅŸ","EsengÃ¼l","Fadime",
"Fatma Demiral","Fatma karabulut","GÃ¼lbeyaz gÃ¼ler","GÃ¼lbeyaz Ã–ztop",
"Keziban tasoluk","Keziban yÃ¼ce","Keziban yÃ¼ksek","Meryem","MÃ¼jgan",
"MÃ¼mine","Neslihan","Ã–zgÃ¼l","Raziye koÃ§ak","Raziye sarÄ±",
"Safiye aslan","Safiye coÅŸkun","Safiye karaca","SatÄ± karakaya",
"SatÄ± taskin","Sultan","ÅengÃ¼l","Åerife avcÄ±","Åerife demiral",
"Ummuhan Ã¶zdemir","YaÅŸar"
];

// Personel listesini Ã§ek
let personeller = [];
try {
    const stored = localStorage.getItem(PERSONEL_KEY);
    personeller = stored ? JSON.parse(stored) : defaultPersoneller;
} catch (e) {
    personeller = defaultPersoneller;
}

// KayÄ±tlÄ± verileri Ã§ek
let data = JSON.parse(localStorage.getItem(DATA_KEY)) || {};

const tableBody = document.getElementById("tableBody");

function sorted() {
    return [...personeller].sort((a, b) => a.localeCompare(b, 'tr'));
}

// --- TABLO OLUÅTURMA ---
function renderTable() {
    let htmlContent = "";
    for(let t = 19; t >= 1; t--) {
        for(let s = 1; s <= 6; s++) {
            const id = `${t}-${s}`;
            htmlContent += `
            <tr data-id="${id}">
                <td><b>${t}</b></td>
                <td>${s}</td>
                <td>${createPersonelSelect(id)}</td>
                <td>${createCountSelect(id)}</td>
            </tr>`;
        }
    }
    tableBody.innerHTML = htmlContent;
    restoreValues();
}

function createPersonelSelect(id) {
    let options = `<option value="">SeÃ§iniz</option>`;
    sorted().forEach(p => {
        options += `<option value="${p}">${p}</option>`;
    });
    return `<select onchange="save('${id}', 'p', this.value)">${options}</select>`;
}

function createCountSelect(id) {
    let options = "";
    for(let i = 0; i <= 500; i++) {
        options += `<option value="${i}">${i}</option>`;
    }
    return `<select onchange="save('${id}', 'k', this.value)">${options}</select>`;
}

// --- KAYIT VE Ä°ÅLEMLER ---

function save(id, type, value) {
    if (!data[id]) data[id] = {};
    data[id][type] = value;
    
    if (value === "" || value === "0") {
        if (type === 'p' && value === "") delete data[id].p;
        if (type === 'k' && value === "0") delete data[id].k;
        if (Object.keys(data[id]).length === 0) delete data[id];
    }

    localStorage.setItem(DATA_KEY, JSON.stringify(data));
    calc();
}

function restoreValues() {
    Object.keys(data).forEach(id => {
        const row = document.querySelector(`tr[data-id="${id}"]`);
        if (row) {
            const selects = row.querySelectorAll("select");
            if (data[id].p) selects[0].value = data[id].p;
            if (data[id].k) selects[1].value = data[id].k;
        }
    });
    calc();
}

function calc() {
    let sum = 0;
    Object.values(data).forEach(item => {
        sum += Number(item.k || 0);
    });
    document.getElementById("total").innerText = "Toplam Kesilen Bitki: " + sum;
}

// --- RAPORLAMA VE ARÅÄ°V SÄ°STEMÄ° ---

function finishDay() {
    if(Object.keys(data).length === 0) {
        alert("Kaydedilecek veri yok!");
        return;
    }
    
    if(!confirm("GÃ¼nÃ¼ bitirmek Ã¼zeresiniz.\n\nVeriler 'Ã–lÃ¼ Bitki' olarak arÅŸive eklenecek ve tablo temizlenecek.\n\nOnaylÄ±yor musunuz?")) return;

    let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
    const bugun = new Date().toLocaleDateString('tr-TR');
    const saat = new Date().toLocaleTimeString('tr-TR');

    Object.keys(data).forEach(id => {
        const item = data[id];
        if(item.p && item.k && item.k != "0") {
            const [tunel, sira] = id.split("-");
            history.push({
                tarih: bugun,
                saat: saat,
                tur: "Ã–lÃ¼ Bitki", // Ä°Å TÃœRÃœ FARKLI
                personel: item.p,
                tunel: tunel,
                sira: sira,
                adet: item.k
            });
        }
    });

    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));

    data = {};
    localStorage.removeItem(DATA_KEY);
    document.querySelectorAll("select").forEach(el => {
        if (el.options[0].text === "SeÃ§iniz") el.value = "";
        else el.value = "0";
    });
    calc();

    alert("âœ… Veriler arÅŸive eklendi.");
}

function downloadReport() {
    let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
    if(history.length === 0) {
        alert("HenÃ¼z kaydedilmiÅŸ bir geÃ§miÅŸ rapor yok.");
        return;
    }

    let csvContent = "\uFEFFTarih;Saat;Ä°ÅŸ TÃ¼rÃ¼;Personel;TÃ¼nel;SÄ±ra;Miktar\n";

    history.forEach(row => {
        csvContent += `${row.tarih};${row.saat};${row.tur};${row.personel};${row.tunel};${row.sira};${row.adet}\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", "genel_rapor_" + new Date().toLocaleDateString('tr-TR') + ".csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function clearPage() {
    if(!confirm("DÄ°KKAT: Veriler kaydedilmeden silinecek! Emin misiniz?")) return;
    
    data = {};
    localStorage.removeItem(DATA_KEY);
    
    document.querySelectorAll("select").forEach((el) => {
        if (el.options[0].text === "SeÃ§iniz") el.value = "";
        else el.value = "0";
    });
    
    calc();
}

renderTable();

</script>
</body>
</html>
