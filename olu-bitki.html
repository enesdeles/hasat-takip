<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ã–lÃ¼ Bitki Kesimi</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;padding:10px}
h1{text-align:center;color:#c62828}
button{width:100%;padding:12px;margin-top:8px;font-size:16px;background:#c62828;color:#fff;border:none;border-radius:6px;cursor:pointer}
button.blue{background:#1565c0}
button.gray{background:#607d8b}
button.pdf{background:#f44336}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#fdecea;color:#c62828}
select{width:100%;padding:8px;font-size:14px;border-radius:4px;border:1px solid #ccc}
#total{text-align:center;font-size:18px;font-weight:bold;margin:15px 0;padding:10px;background:#fff;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.action-box{background:#fff; padding:15px; border-radius:8px; border:1px solid #ddd; margin-top:10px}
</style>
</head>
<body>

<h1>ğŸŒ¿ Ã–lÃ¼ Bitki Kesimi</h1>
<button class="gray" onclick="window.location.href='index.html'">â¬…ï¸ Hasat Takibe DÃ¶n</button>

<table id="table">
    <thead>
        <tr>
            <th style="width:15%">TÃ¼nel</th>
            <th style="width:15%">SÄ±ra</th>
            <th>Personel</th>
            <th style="width:20%">Adet</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<div id="total">Toplam Kesilen: 0</div>

<div class="action-box">
    <button class="pdf" onclick="generatePDF()">ğŸ“„ Tabloyu PDF Yap (PaylaÅŸ)</button>
    <button class="blue" onclick="finishDay()">ğŸ’¾ GÃ¼nÃ¼ Bitir ve ArÅŸivle</button>
    <button class="gray" onclick="downloadReport()">ğŸ“Š Eski KayÄ±tlarÄ± Excel Ä°ndir</button>
</div>

<script>
// ANAHTARLAR (index.html ile aynÄ± olmalÄ±)
const PERSONEL_KEY = "sera_personeller"; 
const DATA_KEY = "olu_bitki_data";
const HISTORY_KEY = "genel_is_gecmisi";

// VarsayÄ±lan Personel Listesi (EÄŸer hafÄ±za boÅŸsa)
const defaultP = ["Akile","Beyhan","Emine tÃ¼rk","Emine yavuz","EmiÅŸ","EsengÃ¼l","Fadime","Fatma Demiral","Fatma karabulut","GÃ¼lbeyaz gÃ¼ler","GÃ¼lbeyaz Ã–ztop","Keziban tasoluk","Keziban yÃ¼ce","Keziban yÃ¼ksek","Meryem","MÃ¼jgan","MÃ¼mine","Neslihan","Ã–zgÃ¼l","Raziye koÃ§ak","Raziye sarÄ±","Safiye aslan","Safiye coÅŸkun","Safiye karaca","SatÄ± karakaya","SatÄ± taskin","Sultan","ÅengÃ¼l","Åerife avcÄ±","Åerife demiral","Ummuhan Ã¶zdemir","YaÅŸar"];

// Personelleri localStorage'dan Ã§ek
let personeller = JSON.parse(localStorage.getItem(PERSONEL_KEY)) || defaultP;
let data = JSON.parse(localStorage.getItem(DATA_KEY)) || {};

// Alfabetik sÄ±ralama
function sorted() { 
    return [...personeller].sort((a, b) => a.localeCompare(b, 'tr')); 
}

// Tabloyu OluÅŸturma
function renderTable() {
    let html = "";
    for(let t = 19; t >= 1; t--) {
        for(let s = 1; s <= 6; s++) {
            const id = `${t}-${s}`;
            html += `<tr data-id="${id}">
                <td><b>${t}</b></td>
                <td>${s}</td>
                <td>${createPersonelSelect(id)}</td>
                <td>${createCountSelect(id)}</td>
            </tr>`;
        }
    }
    document.getElementById("tableBody").innerHTML = html;
    restoreValues();
}

function createPersonelSelect(id) {
    let options = `<option value="">SeÃ§iniz</option>`;
    sorted().forEach(p => {
        options += `<option value="${p}">${p}</option>`;
    });
    return `<select onchange="saveData('${id}','p',this.value)">${options}</select>`;
}

function createCountSelect(id) {
    let options = "";
    for(let i = 0; i <= 500; i++) {
        options += `<option value="${i}">${i}</option>`;
    }
    return `<select onchange="saveData('${id}','k',this.value)">${options}</select>`;
}

function saveData(id, type, val) {
    if(!data[id]) data[id] = {};
    data[id][type] = val;
    localStorage.setItem(DATA_KEY, JSON.stringify(data));
    calculateTotal();
}

function calculateTotal() {
    let sum = 0;
    Object.values(data).forEach(item => sum += Number(item.k || 0));
    document.getElementById("total").innerText = "Toplam Kesilen: " + sum;
}

function restoreValues() {
    Object.keys(data).forEach(id => {
        const row = document.querySelector(`tr[data-id="${id}"]`);
        if (row) {
            const selects = row.querySelectorAll("select");
            if(data[id].p) selects[0].value = data[id].p;
            if(data[id].k) selects[1].value = data[id].k;
        }
    });
    calculateTotal();
}

// PDF OLUÅTURMA
async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const tarih = new Date().toLocaleDateString('tr-TR');
    
    doc.text("Olu Bitki Kesim Raporu - " + tarih, 14, 15);
    
    let tableRows = [];
    Object.keys(data).forEach(id => {
        if(data[id].p && data[id].k > 0) {
            const [tun, sir] = id.split("-");
            tableRows.push([tun, sir, data[id].p, data[id].k]);
        }
    });

    if(tableRows.length === 0) { alert("KayÄ±tlÄ± veri bulunamadÄ±!"); return; }

    doc.autoTable({
        head: [['TÃ¼nel', 'SÄ±ra', 'Personel', 'Adet']],
        body: tableRows,
        startY: 20,
        styles: { font: 'helvetica', fontSize: 10 }
    });

    doc.save(`Olu_Bitki_${tarih}.pdf`);
}

// GÃœNÃœ BÄ°TÄ°R VE ARÅÄ°VLE
function finishDay() {
    if(!confirm("BugÃ¼nkÃ¼ Ã¶lÃ¼ bitki verileri arÅŸive eklenecek ve sayfa temizlenecek. OnaylÄ±yor musunuz?")) return;
    
    let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
    const tarih = new Date().toLocaleDateString('tr-TR');

    Object.keys(data).forEach(id => {
        if(data[id].p && data[id].k > 0) {
            const [tun, sir] = id.split("-");
            history.push({
                tarih: tarih,
                tur: "Ã–lÃ¼ Bitki",
                p: data[id].p,
                t: tun,
                s: sir,
                a: data[id].k
            });
        }
    });

    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    data = {};
    localStorage.removeItem(DATA_KEY);
    alert("BaÅŸarÄ±yla arÅŸivlendi!");
    location.reload();
}

// EXCEL (CSV) Ä°NDÄ°R
function downloadReport() {
    let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
    if(history.length === 0) { alert("ArÅŸivde kayÄ±t yok!"); return; }
    
    // UTF-8 BOM ve NoktalÄ± VirgÃ¼l (TÃ¼rkÃ§e Excel iÃ§in en uyumlu format)
    let csv = "\uFEFFTarih;Ä°ÅŸ TÃ¼rÃ¼;Personel;TÃ¼nel;SÄ±ra;Adet\n";
    
    history.forEach(r => {
        // Tarih formatÄ±nÄ± Excel'in kafasÄ±nÄ± karÄ±ÅŸtÄ±rmayacak ÅŸekilde GG.AA.YYYY yapÄ±yoruz
        csv += `${r.tarih};${r.tur};${r.p};${r.t};${r.s};${r.a}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Sera_Olu_Bitki_Raporu.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycby3vpGSGGHkU5_gYM3NpfUwk6J05qNWZpHsTA0-ZYWlOcdHFkX9nJU20VaLbRyMSd7Phw/exec";

async function sendToGoogleSheets() {
    let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
    if(history.length === 0) { alert("GÃ¶nderilecek veri yok!"); return; }

    const button = event.target;
    button.innerText = "GÃ¶nderiliyor...";
    button.disabled = true;

    try {
        const response = await fetch(GOOGLE_SHEET_URL, {
            method: "POST",
            mode: "no-cors", // GÃ¼venlik kÄ±sÄ±tlamasÄ±nÄ± aÅŸmak iÃ§in
            cache: "no-cache",
            body: JSON.stringify(history)
        });
        
        alert("âœ… Veriler Google E-Tablolara baÅŸarÄ±yla gÃ¶nderildi!");
        // GÃ¶nderilen verileri arÅŸivden silmek isterseniz:
        // localStorage.removeItem(HISTORY_KEY); 
    } catch (error) {
        console.error(error);
        alert("âŒ Bir hata oluÅŸtu.");
    } finally {
        button.innerText = "ğŸ“Š Google E-Tablolara GÃ¶nder";
        button.disabled = false;
    }
}

// Sayfa yÃ¼klendiÄŸinde tabloyu Ã§iz
renderTable();
</script>
</body>
</html>
